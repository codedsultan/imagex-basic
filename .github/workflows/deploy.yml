
# .github/workflows/deploy.yml
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Deploy Laravel & Build Frontend

on:
  push:
    branches: [ main ]

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js (User Frontend)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/user/package-lock.json

      - name: Install & Build User Frontend
        working-directory: frontend/user
        run: |
          npm ci
          npm run build

  deploy:
    runs-on: ubuntu-latest
    needs: build-frontend

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add GitHub to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts

      - name: Add Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 2222 -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Configure git to use merge
        run: git config --global pull.rebase false

      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2222
          script: |
            cd "${{ secrets.DEPLOY_PATH }}"
            git reset --hard origin/main
            git pull origin main

            sudo chown -R www-data:www-data /var/www/apps/imagexbasic
            sudo chmod -R 777 /var/www/apps/imagexbasic

            cd ../docker
            docker-compose stop imagexbasic
            docker-compose rm -f imagexbasic
            docker-compose up -d imagexmysql redis imagexbasic

            docker-compose exec -T imagexbasic composer install

            docker-compose exec -T imagexbasic bash -c "cd frontend/user && npm install && npm run build && rm -rf node_modules"

            docker-compose exec -T imagexbasic php artisan migrate --force
