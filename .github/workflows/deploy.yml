
name: Deploy Laravel & Build Frontend

on:
  push:
    branches: [ main ]

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js (User Frontend)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/user/package-lock.json

      - name: Install PHP dependencies
        run: composer install --prefer-dist --no-progress --no-scripts

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, gd, zip
          coverage: none

      - name: Install & Build User Frontend
        working-directory: frontend/user
        run: |
          npm ci
          npm run build

  build-docker-image:
    runs-on: ubuntu-latest
    needs: build-frontend
    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.PAT_TOKEN }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Cache Docker layers
      uses: actions/cache@v3
      with:
        path: ~/.cache/buildx
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    # - name: Build and push Docker image
    #   run: |
    #     docker build -t ghcr.io/codedsultan/imagex-basic:latest .
    #     docker push ghcr.io/codedsultan/imagex-basic:latest
    - name: Build and push Docker image
      id: docker_build # Add an ID to reference outputs
      run: |
        TAG=$(git rev-parse --short HEAD)
        echo "tag=$TAG" >> $GITHUB_OUTPUT # Make tag available to other steps/jobs
        docker build -t ghcr.io/codedsultan/imagex-basic:$TAG -t ghcr.io/codedsultan/imagex-basic:latest .
        docker push ghcr.io/codedsultan/imagex-basic:$TAG
        docker push ghcr.io/codedsultan/imagex-basic:latest # Optional: still push latest

    - name: Scan image for vulnerabilities
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/codedsultan/imagex-basic:${{ steps.docker_build.outputs.tag }}' # Use specific tag
        format: 'table'
        exit-code: '1' # Fail workflow on critical vulnerabilities
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
  deploy:
    runs-on: ubuntu-latest
    needs: build-backend-image

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add GitHub to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts

      - name: Add Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 2222 -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Configure git to use merge
        run: git config --global pull.rebase false

      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2222
          script: |
            cd "${{ secrets.DEPLOY_PATH }}"
            git reset --hard origin/main
            git pull origin main

            sudo chown -R www-data:www-data /var/www/apps/imagexbasic
            sudo chmod -R 777 /var/www/apps/imagexbasic

            cd ../docker
            docker-compose stop imagexbasic
            docker-compose rm -f imagexbasic
            docker-compose up -d imagexmysql redis imagexbasic

            docker-compose exec -T imagexbasic composer install
            docker-compose exec -T imagexbasic php artisan optimize:clear

            # docker-compose exec -T imagexbasic bash -c "cd frontend/user && npm install && npm run build && rm -rf node_modules"

            # Before migrations
            docker-compose exec -T imagexbasic php artisan down || true # Allow failure if already down
            # Migrations
            docker-compose exec -T imagexbasic php artisan migrate --force
            # After successful operations
            docker-compose exec -T imagexbasic php artisan up

